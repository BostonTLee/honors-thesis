---
title: "Honors Thesis Working Document"
author: "Boston Lee"
date: "9/19/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(knitr)
library(tidyverse)
```

# EDA

## Numerical summaries

```{r read-data}
mental_health_df <- read_csv("../data/preprocessed/mental_health_2018.csv")
mental_health_df$substate_region_id <- as.character(mental_health_df$substate_region_id)
```

```{r summarize-func}

#' Given a dataframe, return a column-level summary of the mean and sd
#' of the numeric columns
#'
#' @param df A dataframe with numeric columns
#' @return A dataframe with three columns: name_col (column name), sd, and mean
summarize_data <- function(df) {
  funcs <- list(mean = ~ mean(.x), sd = ~ sd(.x))
  mean_df <- summarize_func(df, "mean")
  sd_df <- summarize_func(df, "sd")
  full_summary <- inner_join(mean_df, sd_df, by = "col_name")
  return(full_summary)
}

#' Given a dataframe, return a column-level summary of the mean and sd
#' of the numeric columns
#'
#' @param df A dataframe with numeric columns
#' @return A dataframe with two columns: The original column name and the
#'   func summary of the original (numeric) column values
summarize_func <- function(df, func_name) {
  func <- get(func_name)
  namestring <- paste(func_name, "{.col}", sep = "")
  func_df <- df %>%
    summarize(across(where(is.numeric), func, .names = namestring)) %>%
    pivot_longer(
      cols = starts_with(func_name),
      names_to = "col_name",
      names_prefix = func_name,
      values_to = func_name,
      values_drop_na = FALSE
    )

  return(func_df)
}
```

## Visualization

```{r hist-func}

#' Given a dataframe and a variable name, return a ggplot histogram of the
#' named variable
#'
#' @param df A dataframe
#' @param variable A variable name (string) which is a column of \code{df}
#' @return A ggplot2 object
histogram_variable <- function(df, variable) {
  plot <- ggplot(data = df) +
    theme_bw() +
    geom_histogram(aes_string(variable), fill = "seagreen", color = "black") +
    ggtitle(sprintf("Histogram of %s", variable)) +
    xlab(variable)
  return(plot)
}
```

```{r generate-boxplots}
column_names <- colnames(mental_health_df)
inds <- sapply(mental_health_df, is.numeric)
for (i in seq_len(length(colnames(mental_health_df)))) {
  varname <- column_names[i]
  if (inds[i]) {
    plot <- histogram_variable(mental_health_df, varname)
    ggsave(paste("./plots/", varname, "_boxplot.png", sep = ""), plot)
    print(plot)
  }
}
```

```{r map-func-county}
map_var <- function(mental_health_df, var_name) {
  # Grab county FIPS, pad with zeros to match data, and pull out columns
  maps::county.fips %>%
    as_tibble() %>%
    mutate(fips = str_pad(fips, 5, "left", "0")) %>%
    extract(polyname, c("region", "subregion"), "^([^,]+),([^,]+)$") ->
  fips_df
  head(fips_df)
  # Join county map objects with FIPS, and then use that linkage
  # to join the mental health data
  map_data("county") %>%
    left_join(fips_df) %>%
    left_join(mental_health_df) ->
  fips_county_df
  head(fips_county_df)
  # Plot overall
  fips_county_df %>%
    ggplot(aes(long, lat, group = group)) +
    geom_polygon(aes_string(fill = var_name), color = "gray70", size = 0.05) +
    coord_map() +
    ggtitle(paste("Map of ", var_name, " across the United States")) +
    scale_fill_distiller(palette = "Spectral") +
    theme_void()
}
```

```{r map-samhsa}
# samhsa_vars <- c(
#   "prop_suicidal_thoughts",
#   "prop_MDE",
#   "prop_alcohol_use_disorder"
# )
# for (samhsa_var in samhsa_vars) {
#   map_plot <- map_var(mental_health_df, samhsa_var)
#   print(map_plot)
#   ggsave(paste("./maps/", samhsa_var, "_map.png", sep = ""), map_plot)
# }

samhsa_vars <- c(
  "prop_suicidal_thoughts",
  "prop_MDE",
  "prop_alcohol_use_disorder"
)
plot_and_save_vars <- function(df, vars, filename_suffix) {
  for (var in vars) {
    map_plot <- map_var(df, var)
    print(map_plot)
    ggsave(paste("./maps/", var, "_", filename_suffix, ".png", sep = ""), map_plot)
  }
}

plot_and_save_vars(mental_health_df, samhsa_vars, "")
```

```{r map-acs}
acs_vars <- c(
  "prop_below_poverty_level",
  "median_household_income"
)
plot_and_save_vars(mental_health_df, acs_vars, "")
# for (acs_var in acs_vars) {
#   map_plot <- map_var(mental_health_df, acs_var)
#   print(map_plot)
#   ggsave(paste("./maps/", acs_var, "_map.png", sep = ""), map_plot)
# }
```


# Modeling


## General Modeling Functions

We can create a general framework for including variables in our model
for a given dataset (of course requiring that the predictor and response
variables are present). The model will need to be a logistic regression
model, given that all of the proposed responses are proportions.

```{r nonspatial-lm-funcs}
suicidal_thoughts_lm <- function(df) {
  suicidal_thoughts_lm <- lm(
    prop_suicidal_thoughts ~ .,
    data = select(
      df, -c(region_id, prop_alcohol_use_disorder, prop_MDE)
    )
  )
  return(suicidal_thoughts_lm)
}

alcohol_use_disorder_lm <- function(df) {
  alcohol_use_disorder_lm <- lm(
    prop_alcohol_use_disorder ~ .,
    data = select(
      df, -c(region_id, prop_suicidal_thoughts, prop_MDE)
    )
  )
  return(alcohol_use_disorder_lm)
}

MDE_lm <- function(df) {
  MDE_lm <- lm(
    prop_MDE ~ .,
    data = select(
      df, -c(region_id, prop_alcohol_use_disorder, prop_suicidal_thoughts)
    )
  )
  return(MDE_lm)
}
```

## Datasets for primary analysis

```{r base-data}
base_model_df <- mental_health_df %>%
  mutate(region_id = as.factor(paste(as.character(substate_region_id), as.character(state_fips), sep = "-"))) %>%
  group_by(region_id) %>%
  mutate(pop_weight = total_pop / sum(total_pop)) %>%
  summarize_if(is.numeric, ~ sum(. * pop_weight)) %>%
  select(-c(total_pop, pop_weight))
```

We will have three primary groups of models. Each group will consist of three models, with each of the SAMHSA variables as responses. The datasets will be as follows:



1. Predictor: Proportion below poverty level; control variables

```{r average-data}
primary_model_df <- base_model_df %>% select(-median_household_income)
print(primary_model_df)
```

1. Predictor: Proportion below poverty level; median income;  control variables

Here is the data as a population-weighted average, only including a unique row
ID and the numeric variables:

```{r average-data-income}
model_with_income_df <- base_model_df
print(model_with_income_df)
```

```{r summary-table-with-income}
summarize_data(model_with_income_df) %>%
  column_to_rownames("col_name") %>%
  round(3) %>%
  kable("latex")
```

1. Predictor: Proportion below poverty level; indicator for state; control variables

```{r average-data-state}
model_with_state_df <- mental_health_df %>%
  mutate(
    region_id = as.factor(paste(as.character(substate_region_id), as.factor(state_fips), sep = "-")),
    state = as.factor(state)
  ) %>%
  group_by(state, region_id) %>%
  mutate(pop_weight = total_pop / sum(total_pop)) %>%
  summarize_if(is.numeric, ~ sum(. * pop_weight)) %>%
  select(-c(total_pop, pop_weight, median_household_income))
print(model_with_state_df)
```

```{r }
# MDE_with_state_glm <- MDE_model(model_with_state_df)
# summary(MDE_with_state_glm)
# plot(MDE_with_state_glm, which = 1)
#
# suicidal_thoughts_with_state_glm <-
#   suicidal_thoughts_model(model_with_state_df)
# summary(suicidal_thoughts_with_state_glm)
# plot(suicidal_thoughts_with_state_glm, which = 1)
#
# alcohol_use_disorder_with_state_glm <-
#   alcohol_use_disorder_model(model_with_state_df)
# summary(alcohol_use_disorder_with_state_glm)
# plot(alcohol_use_disorder_with_state_glm, which = 1)
```

## Maps accurate to modeling data

The EDA maps simply described the raw data. However, the data actually
used was aggregated. To show an accurate depiction of the data for the
models, we need to revisit mapping:

```{r map-level-model-df}
modified_full_df <- mental_health_df %>%
  mutate(
    region_id = as.factor(paste(as.character(substate_region_id), as.factor(state_fips), sep = "-"))
  ) %>%
  select(c(region_id, substate_region_id, county_fips, fips))
map_model_df <- modified_full_df %>%
  full_join(model_with_income_df)
# map_model_df <- model_df %>%
#   full_join(modified_full_df)
```

```{r plot-save-new-maps}
plot_and_save_vars(map_model_df, samhsa_vars, "aggregated")
plot_and_save_vars(map_model_df, acs_vars, "aggregated")
```

```{r scatters}
# ggplot(data = model_df) +
#   geom_point(aes(x = median_household_income, y = prop_suicidal_thoughts)) +
#   geom_smooth(aes(x = median_household_income, y = prop_suicidal_thoughts))

```

## Models

We will fit three types of model all with the same procedure, so we will make the process slightly easier as follows:

```{r model-procedure-func}
make_lms <- function(df) {
  ret_list <- vector(mode = "list")
  ret_list[["prop_MDE"]] <- MDE_lm(df)
  ret_list[["prop_suicidal_thoughts"]] <- suicidal_thoughts_lm(df)
  ret_list[["prop_alcohol_use_disorder"]] <- alcohol_use_disorder_lm(df)
  return(ret_list)
}
```

We can also extract the coefficient of interest as follows:

```{r tabulate-poverty-func}
extract_coef <- function(model, variable) {
  return(model$coefficients[[variable]])
}
extract_pval <- function(model, variable) {
  return(coef(summary(model))[variable, "Pr(>|t|)"])
}
poverty_table <- function(model_list) {
  print(model_list[["prop_MDE"]]$coefficients[["prop_below_poverty_level"]])
  ret_table <- data.frame(
    c(
      "Major Depressive Episode (MDE)",
      "Suicidal Thoughts",
      "Alcohol Use Disorder"
    ),
    c(
      extract_coef(model_list[["prop_MDE"]], "prop_below_poverty_level"),
      extract_coef(model_list[["prop_suicidal_thoughts"]], "prop_below_poverty_level"),
      extract_coef(model_list[["prop_alcohol_use_disorder"]], "prop_below_poverty_level")
    ),
    c(
      extract_pval(model_list[["prop_MDE"]], "prop_below_poverty_level"),
      extract_pval(model_list[["prop_suicidal_thoughts"]], "prop_below_poverty_level"),
      extract_pval(model_list[["prop_alcohol_use_disorder"]], "prop_below_poverty_level")
    )
  )
  names(ret_table) <- c(
    "Response variable",
    "Coefficient",
    "$p$-value"
  )
  return(ret_table)
}
```

```{r table-primary}
primary_table <- poverty_table(make_lms(primary_model_df))
primary_table[["$p$-value"]] <- p.adjust(primary_table[["$p$-value"]], "holm")
primary_table %>% kable("latex")
poverty_table(make_lms(model_with_income_df)) %>% kable("latex")
poverty_table(make_lms(model_with_state_df)) %>% kable("latex")
```

### Primary models

```{r primary-models}
primary_model_list <- make_lms(primary_model_df)
```

### Secondary/Sensitivity Models

```{r generating-non-primary-models}
model_with_income_list <- make_lms(model_with_income_df)
model_with_state_list <- make_lms(model_with_state_df)
```

# Discussion

```{r nonspatial-glm-funcs}
suicidal_thoughts_glm <- function(df) {
  suicidal_thoughts_glm <- glm(
    prop_suicidal_thoughts ~ .,
    data = select(
      df, -c(region_id, prop_alcohol_use_disorder, prop_MDE)
    ),
    family = "binomial"
  )
  return(suicidal_thoughts_glm)
}

alcohol_use_disorder_glm <- function(df) {
  alcohol_use_disorder_glm <- glm(
    prop_alcohol_use_disorder ~ .,
    data = select(
      df, -c(region_id, prop_suicidal_thoughts, prop_MDE)
    ),
    family = "binomial"
  )
  return(alcohol_use_disorder_glm)
}

MDE_glm <- function(df) {
  MDE_glm <- glm(
    prop_MDE ~ .,
    data = select(
      df, -c(region_id, prop_alcohol_use_disorder, prop_suicidal_thoughts)
    ),
    family = "binomial"
  )
  return(MDE_glm)
}
```
